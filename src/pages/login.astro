---
import AuthLayout from "@/layouts/AuthLayout.astro";
import { LoginForm } from "@/components/auth/LoginForm";
import { createSupabaseServerInstance } from "@/db/supabase.client";

// Check if user is already authenticated
// Since /login is a public route, we need to manually check the session
const supabase = createSupabaseServerInstance({
  headers: Astro.request.headers,
  cookies: Astro.cookies,
});

const {
  data: { user },
} = await supabase.auth.getUser();

if (user) {
  return Astro.redirect("/");
}

// Check if user just reset their password
const url = new URL(Astro.request.url);
const resetSuccess = url.searchParams.get("reset") === "success";
---

<AuthLayout title="Login - SEO Query Insights Dashboard">
  <div class="space-y-6">
    <div class="space-y-2">
      <h2 class="text-2xl font-semibold text-foreground">Welcome back</h2>
      <p class="text-sm text-muted-foreground">Sign in to your account to continue</p>
    </div>

    {
      resetSuccess && (
        <div class="rounded-md bg-green-50 dark:bg-green-950/20 border border-green-600/50 p-4" role="alert">
          <p class="text-sm text-green-800 dark:text-green-200">
            Password successfully reset. Please log in with your new password.
          </p>
        </div>
      )
    }

    <LoginForm client:load />
  </div>
</AuthLayout>
